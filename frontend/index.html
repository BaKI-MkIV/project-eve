<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MVP RPG Market</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg: #f5f6f8;
            --panel: #ffffff;
            --border: #dcdcdc;
            --text: #222;
            --accent: #3b82f6;
            --danger: #c0392b;
            --success: #2ecc71;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            font-family: Arial, sans-serif;
        }

        h1 {
            margin-top: 0;
        }

        h2, h3 {
            margin: 0 0 10px 0;
        }

        .section {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        button {
            padding: 6px 12px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 4px;
        }

        button:hover {
            background: #f0f0f0;
        }

        input, select, textarea {
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        form {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background: #f0f0f0;
        }

        .hidden {
            display: none;
        }

        #output {
            white-space: pre-wrap;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            color: var(--success);
        }

        #error {
            white-space: pre-wrap;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            color: var(--danger);
        }

        .actions button {
            margin-right: 4px;
            font-size: 12px;
        }

        #bulkJson {
            width: 100%;
            height: 120px;
        }
    </style>
</head>

<body>

<h1>MVP RPG Market</h1>

<div class="section">
    <h2>Активные лоты</h2>
    <button onclick="fetchMarketOrders()">Загрузить лоты</button>

    <table id="marketTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Тип</th>
            <th>Продукт</th>
            <th>Всего</th>
            <th>Остаток</th>
            <th>Цена</th>
            <th>Валюта</th>
            <th>Контрагент</th>
            <th>Комиссия</th>
            <th>Истекает</th>
            <th>Статус</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="section">
    <h2>Вход в аккаунт</h2>
    <form>
        <input id="loginInput" placeholder="Login" required>
        <input id="passwordInput" type="password" placeholder="Password" required>
        <button type="button" onclick="handleLogin()">Войти</button>
    </form>
</div>

<div class="section hidden" id="masterPanel">
    <h2>Панель мастера</h2>

    <h3>Создать пользователя</h3>
    <form>
        <input id="createUserActorId" placeholder="Actor ID (опционально)" type="number">
        <select id="createUserRole">
            <option value="player">Player</option>
            <option value="master">Master</option>
        </select>
        <button type="button" onclick="createUser()">Создать</button>
    </form>

    <h3>Создать актора</h3>
    <form>
        <input id="actorName" placeholder="Имя актора" required>
        <textarea id="actorDescription" placeholder="Описание"></textarea>
        <select id="actorType">
            <option value="player">Player</option>
            <option value="npc">NPC</option>
            <option value="bank">Bank</option>
            <option value="merchant">Merchant</option>
            <option value="system">System</option>
        </select>
        <input id="actorUserId" type="number" placeholder="User ID (опционально)">
        <label><input type="checkbox" id="actorIsSystem"> Is System</label>
        <label><input type="checkbox" id="actorIsHidden"> Is Hidden</label>
        <button type="button" onclick="createActor()">Создать актора</button>
    </form>

    <h3>Создать продукт</h3>
    <form>
        <input id="productName" placeholder="Название" required>
        <textarea id="productDescription" placeholder="Описание"></textarea>
        <input id="productBasePrice" type="number" step="0.01" placeholder="Base Price" required>
        <input id="productTags" placeholder="Теги через запятую">
        <button type="button" onclick="createProduct()">Создать один</button>
    </form>

    <h3>Bulk создание продуктов</h3>
    <textarea id="bulkJson" placeholder='[{"name": "Железо", "description": "...", "base_price": 1.5, "tags": ["metal"]}, ...]'></textarea>
    <button type="button" onclick="bulkCreateProducts()">Загрузить JSON</button>

    <h3>Таблица акторов</h3>
    <button onclick="fetchActors()">Загрузить акторов</button>
    <table id="actorsTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Тип</th>
            <th>Скрыт</th>
            <th>Системный</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>Таблица продуктов</h3>
    <button onclick="fetchProducts()">Загрузить продукты</button>
    <table id="productsTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Описание</th>
            <th>Base Price</th>
            <th>Теги</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="section hidden" id="personalCabinet">
    <h2>Личный кабинет</h2>
    <p><strong>Текущий актор:</strong> <span id="currentActorInfo">Ваш собственный</span> <button onclick="exitImpersonate()">Выйти из актора</button></p>
    <button onclick="fetchMe()">User данные</button>
    <button onclick="fetchMeActor()">Мой актор</button>
    <button onclick="fetchMeWallet()">Кошелёк</button>
    <button onclick="fetchMeInventory()">Инвентарь</button>
</div>

<div class="section hidden" id="createOrderSection">
    <h2>Создать лот</h2>
    <form>
        <select id="orderType">
            <option value="buy">Buy</option>
            <option value="sell">Sell</option>
        </select>
        <input id="orderProduct" type="number" placeholder="Product ID">
        <input id="orderQuantity" type="number" step="0.01" placeholder="Количество">
        <input id="orderUnitPrice" type="number" step="0.01" placeholder="Цена за единицу">
        <input id="orderCurrency" type="number" placeholder="Currency ID">
        <input id="orderBroker" type="number" placeholder="Broker Actor ID">
        <input id="orderBrokerFee" type="number" step="0.01" placeholder="Комиссия %">
        <input id="orderExpires" type="datetime-local">
        <button type="button" onclick="createOrder()">Создать лот</button>
    </form>
</div>

<div class="section hidden" id="transferRequests">
    <h2>Входящие запросы переводов</h2>
    <button onclick="fetchIncomingRequests()">Загрузить</button>

    <table id="requestsTable">
        <thead>
        <tr>
            <th>ID</th>
            <th>Тип</th>
            <th>От кого</th>
            <th>Кому</th>
            <th>Запрошено</th>
            <th>Статус</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="output"></div>
<div id="error"></div>

<script>
    const API_BASE = 'http://localhost:4000/';
    let token = localStorage.getItem('access_token');
    let currentActorId = localStorage.getItem('current_actor_id'); // Для имперсонации мастера

    function setError(msg) {
        document.getElementById('error').innerText = msg || '';
    }

    function setOutput(data) {
        document.getElementById('output').innerText =
            typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    function showLoggedInUI() {
        document.getElementById('personalCabinet').classList.remove('hidden');
        document.getElementById('createOrderSection').classList.remove('hidden');
        document.getElementById('transferRequests').classList.remove('hidden');

        if (localStorage.getItem('role') === 'master') {
            document.getElementById('masterPanel').classList.remove('hidden');
        }

        updateCurrentActorInfo();
    }

    function updateCurrentActorInfo() {
        if (currentActorId) {
            document.getElementById('currentActorInfo').innerText = `ID ${currentActorId} (имперсонация)`;
        } else {
            document.getElementById('currentActorInfo').innerText = 'Ваш собственный';
        }
    }

    if (token) {
        showLoggedInUI();
    }

    function fetchWithAuth(url, method = 'GET', body = null) {
        return fetch(API_BASE + url, {
            method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: body ? JSON.stringify(body) : null
        }).then(res => {
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            return res.json();
        });
    }

    function handleLogin() {
        setError('');
        const login = document.getElementById('loginInput').value;
        const password = document.getElementById('passwordInput').value;

        fetch(API_BASE + 'auth/login/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login, password })
        })
        .then(res => {
            if (!res.ok) throw new Error('Неверный логин или пароль');
            return res.json();
        })
        .then(data => {
            token = data.access;
            localStorage.setItem('access_token', token);
            localStorage.setItem('role', data.user?.role || 'player');
            currentActorId = null;
            localStorage.removeItem('current_actor_id');
            showLoggedInUI();
            setOutput('Успешный вход');
            fetchMarketOrders();
        })
        .catch(err => setError(err.message));
    }

    function fetchMarketOrders() {
        setError('');
        fetch(API_BASE + 'market/orders/')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('marketTable').querySelector('tbody');
                tbody.innerHTML = '';
                data.forEach(o => {
                    const tr = tbody.insertRow();
                    tr.innerHTML = `
                        <td>${o.id}</td>
                        <td>${o.order_type}</td>
                        <td>${o.product_name || o.product}</td>
                        <td>${o.quantity}</td>
                        <td>${o.remaining_quantity}</td>
                        <td>${o.unit_price}</td>
                        <td>${o.currency_code || o.currency}</td>
                        <td>${o.actor_info?.name || '—'}</td>
                        <td>${o.broker_fee_percent}%</td>
                        <td>${o.expires_at}</td>
                        <td>${o.status}</td>
                        <td class="actions">
                            <button onclick="fetchOrderDetails(${o.id})">Детали</button>
                            ${token ? `<button onclick="executeOrder(${o.id})">Исполнить</button>` : ''}
                        </td>
                    `;
                });
            })
            .catch(err => setError(err.message));
    }

    function fetchOrderDetails(id) {
        fetch(API_BASE + `market/orders/${id}/`)
            .then(res => res.json())
            .then(setOutput)
            .catch(err => setError(err.message));
    }

    function executeOrder(id) {
        const quantity = prompt('Количество (оставьте пустым для всего остатка):');
        const body = quantity ? { quantity: parseFloat(quantity) } : {};
        fetchWithAuth(`market/orders/${id}/execute/`, 'POST', body)
            .then(setOutput)
            .then(fetchMarketOrders)
            .catch(err => setError(err.message));
    }

    function createUser() {
        const actor_id = document.getElementById('createUserActorId').value || null;
        const role = document.getElementById('createUserRole').value;
        fetchWithAuth('users/', 'POST', { actor_id, role })
            .then(setOutput)
            .catch(err => setError(err.message));
    }

    function createActor() {
        const data = {
            name: document.getElementById('actorName').value,
            description: document.getElementById('actorDescription').value,
            type: document.getElementById('actorType').value,
            user: document.getElementById('actorUserId').value || null,
            is_system: document.getElementById('actorIsSystem').checked,
            is_hidden: document.getElementById('actorIsHidden').checked
        };
        fetchWithAuth('actors/', 'POST', data)
            .then(setOutput)
            .catch(err => setError(err.message));
    }

    function createProduct() {
        const tags = document.getElementById('productTags').value.split(',').map(t => t.trim()).filter(t => t);
        const data = {
            name: document.getElementById('productName').value,
            description: document.getElementById('productDescription').value,
            base_price: parseFloat(document.getElementById('productBasePrice').value),
            tags: tags
        };
        fetchWithAuth('products/', 'POST', data)
            .then(setOutput)
            .catch(err => setError(err.message));
    }

    function bulkCreateProducts() {
        try {
            const jsonData = JSON.parse(document.getElementById('bulkJson').value);
            fetchWithAuth('products/bulk_create/', 'POST', jsonData)
                .then(setOutput)
                .catch(err => setError(err.message));
        } catch (e) {
            setError('Неверный JSON: ' + e.message);
        }
    }

    function fetchActors() {
        fetchWithAuth('actors/')
            .then(data => {
                const tbody = document.getElementById('actorsTable').querySelector('tbody');
                tbody.innerHTML = '';
                data.forEach(a => {
                    const tr = tbody.insertRow();
                    tr.innerHTML = `
                        <td>${a.id}</td>
                        <td>${a.name}</td>
                        <td>${a.type}</td>
                        <td>${a.is_hidden ? 'Да' : 'Нет'}</td>
                        <td>${a.is_system ? 'Да' : 'Нет'}</td>
                        <td class="actions">
                            <button onclick="impersonateActor(${a.id})">Войти как этот</button>
                        </td>
                    `;
                });
            })
            .catch(err => setError(err.message));
    }

    function fetchProducts() {
        fetch(API_BASE + 'products/')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('productsTable').querySelector('tbody');
                tbody.innerHTML = '';
                data.forEach(p => {
                    const tr = tbody.insertRow();
                    tr.innerHTML = `
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${p.description || ''}</td>
                        <td>${p.base_price}</td>
                        <td>${p.tags?.join(', ') || ''}</td>
                    `;
                });
            })
            .catch(err => setError(err.message));
    }

    function impersonateActor(id) {
        currentActorId = id;
        localStorage.setItem('current_actor_id', id);
        updateCurrentActorInfo();
        setOutput(`Теперь вы действуете от имени актора ID ${id}`);
    }

    function exitImpersonate() {
        currentActorId = null;
        localStorage.removeItem('current_actor_id');
        updateCurrentActorInfo();
        setOutput('Вернулись к своему актору');
    }

    function fetchMe() {
        fetchWithAuth('auth/me/').then(setOutput).catch(err => setError(err.message));
    }

    function fetchMeActor() {
        if (currentActorId) {
            fetch(API_BASE + `actors/${currentActorId}/`)
                .then(res => res.json())
                .then(setOutput)
                .catch(err => setError(err.message));
        } else {
            fetchWithAuth('auth/me/actor/').then(setOutput).catch(err => setError(err.message));
        }
    }

    function fetchMeWallet() {
        if (currentActorId) {
            fetch(API_BASE + `actors/${currentActorId}/`)
                .then(res => res.json())
                .then(actor => {
                    // Здесь можно добавить отдельный эндпоинт, но пока покажем как часть актора
                    setOutput('Кошелёк через имперсонацию не реализован отдельно — используйте /economy/ или добавьте');
                });
        } else {
            fetchWithAuth('auth/me/wallet/').then(setOutput).catch(err => setError(err.message));
        }
    }

    function fetchMeInventory() {
        if (currentActorId) {
            setOutput('Инвентарь через имперсонацию — используйте /inventory/?actor=' + currentActorId + ' (если добавишь фильтр)');
        } else {
            fetchWithAuth('auth/me/inventory/').then(setOutput).catch(err => setError(err.message));
        }
    }

    function createOrder() {
        const data = {
            order_type: document.getElementById('orderType').value,
            product: parseInt(document.getElementById('orderProduct').value),
            quantity: parseFloat(document.getElementById('orderQuantity').value),
            unit_price: parseFloat(document.getElementById('orderUnitPrice').value),
            currency: parseInt(document.getElementById('orderCurrency').value),
            broker: parseInt(document.getElementById('orderBroker').value),
            broker_fee_percent: parseFloat(document.getElementById('orderBrokerFee').value),
            expires_at: document.getElementById('orderExpires').value + ':00Z'
        };
        fetchWithAuth('market/orders/', 'POST', data)
            .then(res => {
                setOutput(res);
                fetchMarketOrders();
            })
            .catch(err => setError(err.message));
    }

    function fetchIncomingRequests() {
        fetchWithAuth('transfer-requests/incoming/')
            .then(data => {
                const tbody = document.getElementById('requestsTable').querySelector('tbody');
                tbody.innerHTML = '';
                data.forEach(r => {
                    const tr = tbody.insertRow();
                    tr.innerHTML = `
                        <td>${r.id}</td>
                        <td>${r.type}</td>
                        <td>${r.from_actor?.name || r.from_actor}</td>
                        <td>${r.to_actor?.name || r.to_actor}</td>
                        <td>${r.requested_amount}</td>
                        <td>${r.status}</td>
                        <td class="actions">
                            <button onclick="respondRequest(${r.id})">Ответить</button>
                            <button onclick="cancelRequest(${r.id})">Отменить</button>
                        </td>
                    `;
                });
            })
            .catch(err => setError(err.message));
    }

    function respondRequest(id) {
        const action = prompt('Действие: accept или reject');
        const amount = prompt('Сумма/количество (для partial accept, иначе всё)');
        const body = { action };
        if (amount) body.amount = parseFloat(amount);
        fetchWithAuth(`transfer-requests/${id}/respond/`, 'POST', body)
            .then(setOutput)
            .catch(err => setError(err.message));
    }

    function cancelRequest(id) {
        fetchWithAuth(`transfer-requests/${id}/cancel/`, 'POST')
            .then(setOutput)
            .catch(err => setError(err.message));
    }
</script>

</body>
</html>
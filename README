1. Аккаунты и пользователи

Один пользователь = один актор

User может быть связан только с одним Actor.

Actor.user может быть NULL только для non-player акторов (NPC, банки, система).

Роли пользователей

Возможные роли: player, master.

System actors не имеют связанного пользователя.

Активность

Только активный пользователь может совершать действия (is_active=True).

2. Акторы

Тип акторов

Возможные значения: player, npc, bank, merchant, system.

System actors

is_system=True → ограничения на баланс и инвентарь не применяются.

System actors не имеют user.

Уникальность

Каждый игрок (player) должен иметь уникальный actor.

Остальные акторы могут быть множественными, но идентифицируемыми по имени/ID.

3. Инвентарь

Количество предметов неотрицательное

InventoryItem.quantity >= 0

Если количество = 0 → запись может быть удалена.

Уникальность пары актер + предмет

Только одна запись InventoryItem на комбинацию (actor, product).

Предмет либо в инвентаре, либо заморожен

Нельзя одновременно хранить предмет в inventory и frozen_inventory.

4. Валюта и баланс

Баланс неотрицательный

ActorBalance.amount >= 0 (кроме system actors).

Одна запись на актор + валюта

UNIQUE(actor_id, currency_id).

Все изменения баланса должны быть атомарными

Только через перевод, freeze/разморозку, списание брокеру или системное уничтожение.

5. Рынок (MarketOrder)

Обеспечение ордера всегда существует

Sell-order: соответствующий FrozenInventory.quantity >= remaining_quantity

Buy-order: соответствующий FrozenBalance.amount >= remaining_quantity * unit_price

Количество и статус ордера

0 <= remaining_quantity <= quantity

status = closed ⇔ remaining_quantity = 0

Active ордер всегда исполним (если не истёк).

Атомарность сделок

Частичная покупка/продажа: деньги и предметы перемещаются одновременно.

Использовать транзакции transaction.atomic.

Арестованные ордера

status = arrested → frozen-активы уничтожаются (не возвращаются).

История сделки фиксируется в логах.

6. Замороженные активы

FrozenInventory

Всегда привязаны к ордеру.

Количество ≥ remaining_quantity.

FrozenBalance

Всегда привязаны к ордеру и валюте.

Amount ≥ необходимой суммы для исполнения ордера.

Система может поддерживать одну или несколько валют

MVP: только золото.

Поддержка нескольких валют предусмотрена через currency_id.

7. Брокер

Брокер всегда есть концептуально
В ордере поле broker_actor_id может быть NULL.
NULL означает, что конкретный брокер не назначен, но фактически комиссия всегда существует и учитывается.
Если указан broker_actor_id, комиссия идёт указанному актору; иначе она «уходит в систему».

8. Время: Истёкшие ордера expires_at < now → нельзя исполнить.

Статусы ордеров терминальные: closed, expired, arrested → не могут вернуться в active.

9. Главный инвариант экономики
    9.1. Каждый предмет и каждая монета имеют единственное местоположение: Inventory, FrozenInventory, ActorBalance, FrozenBalance
Любой предмет или монета не может существовать в двух местах одновременно.